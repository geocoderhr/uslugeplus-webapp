<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UslugePlus WebApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg: var(--tg-theme-bg-color, #0b0f17);
      --text: var(--tg-theme-text-color, #e9eef7);
      --hint: var(--tg-theme-hint-color, rgba(233,238,247,.70));
      --btn: var(--tg-theme-button-color, #3390ec);
      --btnText: var(--tg-theme-button-text-color, #ffffff);
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.10);
      --ok: #21c55d;
      --bad: #ef4444;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--text);}
    .wrap{max-width:820px;margin:0 auto;padding:18px;}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:16px;padding:16px;}
    h1{font-size:20px;margin:0 0 10px}
    p{margin:8px 0;line-height:1.35}
    .hint{color:var(--hint);font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
    button{
      background:var(--btn);color:var(--btnText);border:0;
      padding:10px 14px;border-radius:12px;font-size:14px;cursor:pointer;
    }
    button.secondary{background:rgba(255,255,255,.10)}
    button.danger{background:rgba(239,68,68,.20)}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.10);font-size:12px}
    .ok{color:var(--ok)} .bad{color:var(--bad)}
    pre{
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      padding:12px;border-radius:14px;overflow:auto;max-height:280px;
      font-size:12px;line-height:1.35;
      white-space:pre-wrap;word-break:break-word;
    }
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>UP Debug WebApp</h1>
      <p class="hint">Цель: убедиться, что Mini App даёт initData и API умеет его валидировать.</p>

      <div class="row" id="pills"></div>

      <div class="row">
        <button id="copyBtn">Скопировать initData</button>
        <button id="authBtn">Проверить /auth/telegram</button>
        <button class="secondary" id="showSessionBtn">Показать session</button>
        <button class="danger" id="clearSessionBtn">Очистить session</button>
      </div>

      <p id="status">Загрузка…</p>
      <p class="hint" id="details"></p>

      <p class="hint">initData (фрагмент, 240 символов):</p>
      <pre id="initPreview">—</pre>

      <p class="hint">Ответ API:</p>
      <pre id="apiOut">—</pre>
    </div>
  </div>

  <script>
    const API_BASE = 'https://api.uslugeplus.com';
    const SESSION_KEY = 'up_auth';

    const pills = document.getElementById('pills');
    const addPill = (t) => { const el=document.createElement('div'); el.className='pill'; el.textContent=t; pills.appendChild(el); };

    const statusEl = document.getElementById('status');
    const detailsEl = document.getElementById('details');
    const initPreviewEl = document.getElementById('initPreview');
    const apiOutEl = document.getElementById('apiOut');

    const tg = window.Telegram?.WebApp;

    function setApiOut(objOrText){
      apiOutEl.textContent = typeof objOrText === 'string' ? objOrText : JSON.stringify(objOrText, null, 2);
    }

    function getSession(){
      try { return JSON.parse(sessionStorage.getItem(SESSION_KEY) || 'null'); } catch { return null; }
    }

    function setSession(val){
      sessionStorage.setItem(SESSION_KEY, JSON.stringify(val));
    }

    function clearSession(){
      sessionStorage.removeItem(SESSION_KEY);
    }

    async function callAuth(){
      if (!tg) throw new Error('Telegram SDK not found');
      const initData = tg.initData || '';
      if (!initData) throw new Error('initData is empty');

      const res = await fetch(`${API_BASE}/auth/telegram`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ initData })
      });

      const text = await res.text();
      let json;
      try { json = JSON.parse(text); } catch { json = { raw: text }; }

      return { http: res.status, body: json };
    }

    if (!tg) {
      statusEl.innerHTML = '<span class="bad">Telegram SDK не найден.</span> Открой страницу внутри Telegram.';
      detailsEl.textContent = 'Если открыть в браузере, initData не придёт.';
      initPreviewEl.textContent = '—';
      setApiOut('—');
    } else {
      tg.ready();
      tg.expand();

      addPill('platform: ' + (tg.platform || 'n/a'));
      addPill('version: ' + (tg.version || 'n/a'));

      const user = tg.initDataUnsafe?.user;
      const initData = tg.initData || '';
      const initLen = initData.length;

      statusEl.innerHTML =
        `Telegram detected <span class="ok">✓</span> · initData len=<code>${initLen}</code>` +
        (user ? ` · user=<code>${user.id}</code>` : '');

      detailsEl.textContent =
        `API: ${API_BASE} · session: ` + (getSession() ? 'есть' : 'пусто');

      initPreviewEl.textContent = initData ? initData.slice(0, 240) + (initData.length > 240 ? '…' : '') : '—';

      document.getElementById('copyBtn').addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(initData);
          tg.showPopup?.({ title: 'Готово', message: 'initData скопирован в буфер.' });
        } catch (e) {
          setApiOut('Clipboard error: ' + (e?.message || e));
        }
      });

      document.getElementById('authBtn').addEventListener('click', async () => {
        setApiOut('Запрос…');
        try {
          const out = await callAuth();
          setApiOut(out);

          if (out.http === 200 && out.body && (out.body.ok === true || out.body.user)) {
            setSession(out.body);
            detailsEl.textContent =
              `API: ${API_BASE} · session: есть`;
          }
        } catch (e) {
          setApiOut('Error: ' + (e?.message || e));
        }
      });

      document.getElementById('showSessionBtn').addEventListener('click', () => {
        const s = getSession();
        setApiOut(s ? s : 'session пусто');
      });

      document.getElementById('clearSessionBtn').addEventListener('click', () => {
        clearSession();
        detailsEl.textContent = `API: ${API_BASE} · session: пусто`;
        setApiOut('session очищен');
      });
    }
  </script>
</body>
</html>
