<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>UslugePlus</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>

  <!-- Screen: Language picker (first launch) -->
  <div id="lang-screen" class="hidden">
    <div class="card">
      <h3 id="lang-title">–Ø–∑—ã–∫</h3>
      <p id="lang-subtitle">–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.</p>

      <div class="lang-option" id="lang-ru">
        <span>üá∑üá∫ –†—É—Å—Å–∫–∏–π</span>
        <span class="badge" id="lang-ru-badge">—Å–µ–π—á–∞—Å</span>
      </div>

      <div class="lang-option disabled" id="lang-hr">
        <span>üá≠üá∑ Hrvatski</span>
        <span class="badge" id="lang-hr-badge">–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</span>
      </div>
    </div>
  </div>

  <!-- Screen: Loading/Auth -->
  <div id="loading-screen" class="hidden">
    <div class="loader"></div>
    <p id="loading-text">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...</p>
  </div>

  <!-- Screen: Main Menu (temporary, –ø–æ–∫–∞ –Ω–µ—Ç Policy/Profile) -->
  <div id="main-menu" class="hidden">
    <h3 id="menu-title">–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h3>
    <div class="menu-grid">
      <div class="menu-item" onclick="action('create_request')" id="menu-create">üìù –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</div>
      <div class="menu-item" onclick="action('be_provider')" id="menu-provider">üõ† –Ø –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</div>
      <div class="menu-item" onclick="action('profile')" id="menu-profile">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
      <div class="menu-item" onclick="action('referral')" id="menu-referral">üéÅ –ë–æ–Ω—É—Å—ã</div>
      <div class="menu-item" onclick="action('reset_app')" id="menu-reset">‚ôªÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</div>
    </div>
  </div>

  <script>
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) { tg.ready(); tg.expand(); }

    // i18n skeleton: RU —Å–µ–π—á–∞—Å, HR –ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞ (–≥–æ—Ç–æ–≤–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ–¥ EN –ø–æ–∑–∂–µ)
    const I18N = {
      ru: {
        lang_title: '–Ø–∑—ã–∫',
        lang_subtitle: '–í—ã–±–µ—Ä–∏ —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞. –ü–æ—Ç–æ–º –µ–≥–æ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –ø–æ–º–µ–Ω—è—Ç—å –≤ –ø—Ä–æ—Ñ–∏–ª–µ.',
        ru_badge: '—Å–µ–π—á–∞—Å',
        hr_badge: '–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ',
        loading: '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...',
        menu_title: '–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é',
        m_create: 'üìù –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É',
        m_provider: 'üõ† –Ø –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å',
        m_profile: 'üë§ –ü—Ä–æ—Ñ–∏–ª—å',
        m_referral: 'üéÅ –ë–æ–Ω—É—Å—ã',
        m_reset: '‚ôªÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ',
        auth_error: '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.',
        net_error: '–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º',
        hr_soon: 'Hrvatski –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.'
      },
      hr: {
        // –ü–æ–∫–∞ –ø—É—Å—Ç–æ: –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –ø—Ä–æ—Å—Ç–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∫–ª—é—á–∏
      }
    };

    let lang = localStorage.getItem('up_lang') || 'ru';

    function t(key) {
      const pack = I18N[lang] || I18N.ru;
      return (pack && pack[key]) || (I18N.ru[key]) || key;
    }

    function applyTexts() {
      document.documentElement.lang = lang;

      const set = (id, value) => { const el = document.getElementById(id); if (el) el.textContent = value; };

      set('lang-title', t('lang_title'));
      set('lang-subtitle', t('lang_subtitle'));
      set('lang-ru-badge', t('ru_badge'));
      set('lang-hr-badge', t('hr_badge'));

      set('loading-text', t('loading'));
      set('menu-title', t('menu_title'));

      set('menu-create', t('m_create'));
      set('menu-provider', t('m_provider'));
      set('menu-profile', t('m_profile'));
      set('menu-referral', t('m_referral'));
      set('menu-reset', t('m_reset'));
    }

    function showOnly(screenId) {
      const ids = ['lang-screen', 'loading-screen', 'main-menu'];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (id === screenId) el.classList.remove('hidden');
        else el.classList.add('hidden');
      });
    }

    function setLang(next) {
      lang = next;
      localStorage.setItem('up_lang', lang);
      applyTexts();
    }

    async function startAuth() {
      showOnly('loading-screen');

      try {
        const response = await fetch('https://api.uslugeplus.com/auth/telegram', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ initData: tg ? tg.initData : '' })
        });

        const data = await response.json();

        if (data.ok) {
          showOnly('main-menu');
          console.log('User authorized:', data.user);
        } else {
          alert(t('auth_error'));
        }
      } catch (e) {
        alert(t('net_error'));
      }
    }

    function bootstrap() {
      applyTexts();

      const saved = localStorage.getItem('up_lang');
      if (!saved) {
        showOnly('lang-screen');

        const ru = document.getElementById('lang-ru');
        const hr = document.getElementById('lang-hr');

        if (ru) {
          ru.onclick = () => {
            if (tg) tg.HapticFeedback.impactOccurred('light');
            setLang('ru');
            startAuth();
          };
        }

        if (hr) {
          hr.onclick = () => {
            if (tg) tg.HapticFeedback.impactOccurred('light');
            alert(t('hr_soon'));
          };
        }
      } else {
        setLang(saved);
        startAuth();
      }
    }

    function action(type) {
      if (tg) tg.HapticFeedback.impactOccurred('light');

      if (type === 'reset_app') {
        localStorage.removeItem('up_lang');
        location.reload();
        return;
      }

      alert('–í—ã–±—Ä–∞–Ω–æ: ' + type + '. –°–∫–æ—Ä–æ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ n8n!');
    }

    bootstrap();
  </script>
</body>
</html>
